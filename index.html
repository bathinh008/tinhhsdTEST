<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>T√≠nh H·∫°n S·ª≠ D·ª•ng Cao C·∫•p</title>

<!-- POPUP CALENDAR -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 520px;
        margin: auto;
        background: #f0f3f8;
    }

    h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 28px;
    }

    label { 
        font-weight: bold; 
        margin-top: 12px; 
        display: block; 
        font-size: 18px;
    }

    input {
        width: 100%;
        padding: 14px;
        margin-top: 6px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 18px;
    }

    /* N√∫t c·ªông/tr·ª´ th√°ng */
    .btn-small {
        padding: 12px 18px;
        background: #8e44ad;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin: 10px 6px 0 0;
        font-size: 16px;
        min-width: 120px;
    }

    .btn-small.minus { background: #c0392b; }

    /* Accordion */
    .acc-header {
        background: #dfe6e9;
        padding: 14px;
        border-radius: 10px;
        margin-top: 16px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        font-size: 17px;
    }

    .acc-header:hover { background: #b2bec3; }

    .acc-header .arrow {
        font-size: 20px;
        margin-right: 12px;
        transition: transform 0.25s ease;
    }

    .acc-header.open .arrow { transform: rotate(90deg); }

    .acc-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.35s ease;
        padding-left: 6px;
    }

    .acc-body-inner {
        padding: 12px 0 6px 10px;
    }

    /* N√∫t t√≠nh to√°n / l√†m m·ªõi */
    .btn-row {
        display: flex;
        gap: 12px;
        margin-top: 25px;
    }

    .btn-row button {
        flex: 1;
        padding: 16px;
        font-size: 18px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
    }

    .main-btn { background: #3498db; color: white; }
    .main-btn:hover { background: #217dbb; }

    .refresh-btn { background: #7f8c8d; color: white; }
    .refresh-btn:hover { background: #636e72; }

    /* K·∫øt qu·∫£ */
    .result-box {
        background: white;
        border-radius: 14px;
        padding: 24px;
        margin-top: 25px;
        font-size: 18px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .progress-bar {
        width: 100%;
        height: 24px;
        background: #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        margin: 14px 0 18px 0;
    }

    .progress-fill {
        height: 100%;
        background: #27ae60;
        width: 0%;
        transition: width 0.35s ease;
    }

    .danger { color: red; font-weight: bold; }
    .warning { color: #e67e22; font-weight: bold; }
    .good { color: #27ae60; font-weight: bold; }

    /* L·ªãch s·ª≠ */
    .history-box {
        background: white;
        border-radius: 12px;
        padding: 14px;
        margin-top: 25px;
        font-size: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* ========================== */
    /* üì± T·ªêI ∆ØU CHO MOBILE */
    /* ========================== */
    @media (max-width: 480px) {

		html, body {
			font-size: 4.5vw;
			padding: 0;
			margin: 0;
		}

		body {
			padding: 5vw;           /* ƒë·ªÅu tr√°i ‚Äì ph·∫£i */
			box-sizing: border-box; /* tr√°nh tr√†n */
		}

		h2 {
			font-size: 7vw;
			margin: 0 0 5vw 0;
			text-align: center;
		}

		label {
			font-size: 5vw;
			margin: 4vw 0 2vw 0;
			display: block;
		}

		input {
			width: 100%;
			font-size: 5vw;
			padding: 4vw;
			border-radius: 3vw;
			box-sizing: border-box;
		}

		/* N√∫t nh·ªè trong accordion */
		.btn-small {
			font-size: 4.8vw;
			padding: 4vw;
			min-width: 32vw;
			border-radius: 3vw;
			margin: 3vw 3vw 0 0;
		}

		.acc-header {
			font-size: 5.2vw;
			padding: 4vw;
			border-radius: 3vw;
			margin-top: 4vw;
			box-sizing: border-box;
		}

		.acc-header .arrow {
			font-size: 6vw;
			margin-right: 3vw;
		}

		.acc-body-inner {
			padding: 4vw 0 2vw 3vw;
		}

		/* D√≤ng ch·ª©a 2 n√∫t t√≠nh & l√†m m·ªõi */
		.btn-row {
			display: flex;
			gap: 3vw;
			margin-top: 5vw;
		}

		.btn-row button {
			flex: 1;
			font-size: 5vw;
			padding: 5vw 0;
			border-radius: 3vw;
			box-sizing: border-box;
			width: 100%;
		}

		.result-box {
			padding: 5vw;
			font-size: 5vw;
			margin-top: 6vw;
			border-radius: 3vw;
			line-height: 1.55;
		}

		.progress-bar {
			height: 7vw;
			border-radius: 4vw;
			margin: 4vw 0;
			width: 100%;
		}

		.history-box {
			padding: 4vw;
			font-size: 4.5vw;
			border-radius: 3vw;
			margin-top: 8vw;
		}
	}
</style>
</head>

<body>

<h2>üßÆ T√≠nh H·∫°n S·ª≠ D·ª•ng</h2>

<label>Ng√†y s·∫£n xu·∫•t (MFG)</label>
<input id="mfg" placeholder="dd/mm/yyyy" inputmode="numeric">

<!-- QU√âT ƒê·ªåC  -->
<button class="btn-small" style="background:#2ecc71" onclick="openOCR()">üì∑ Qu√©t ng√†y (OCR)</button>

<!-- ACCORDION C·ªòNG -->
<div class="acc-header" onclick="toggleAcc('accAdd')">
    <span class="arrow">‚ñ∏</span> C·ªông th√°ng HSD nhanh
</div>
<div id="accAdd" class="acc-body">
    <div class="acc-body-inner">
        <button class="btn-small" onclick="addMonths(1)">+ 1 th√°ng</button>
        <button class="btn-small" onclick="addMonths(6)">+ 6 th√°ng</button>
        <button class="btn-small" onclick="addMonths(12)">+ 1 nƒÉm</button>
    </div>
</div>

<!-- ACCORDION TR·ª™ -->
<div class="acc-header" onclick="toggleAcc('accMinus')">
    <span class="arrow">‚ñ∏</span> Tr·ª´ th√°ng HSD nhanh
</div>
<div id="accMinus" class="acc-body">
    <div class="acc-body-inner">
        <button class="btn-small minus" onclick="addMonths(-1)">‚àí 1 th√°ng</button>
        <button class="btn-small minus" onclick="addMonths(-6)">‚àí 6 th√°ng</button>
        <button class="btn-small minus" onclick="addMonths(-12)">‚àí 1 nƒÉm</button>
    </div>
</div>

<label>H·∫°n s·ª≠ d·ª•ng (EXP)</label>
<input id="exp" placeholder="dd/mm/yyyy" inputmode="numeric">

<!-- N√öT T√çNH + L√ÄM M·ªöI -->
<div class="btn-row">
    <button class="main-btn" onclick="calc()">T√≠nh To√°n</button>
    <button class="refresh-btn" onclick="resetAll()">L√†m m·ªõi</button>
</div>

<div id="result"></div>

<h3>L·ªãch s·ª≠ g·∫ßn ƒë√¢y:</h3>
<div id="history" class="history-box"></div>

<script>
// =============================
// M√ÅY QU√âT 
// =============================

let stream;

function openOCR() {
    const modal = document.getElementById("ocrModal");
    modal.style.display = "flex";

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(s => {
        stream = s;
        document.getElementById("ocrVideo").srcObject = s;
    })
    .catch(err => {
        alert("Kh√¥ng th·ªÉ m·ªü camera: " + err);
    });
}

function closeOCR() {
    document.getElementById("ocrModal").style.display = "none";
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
    }
}

async function captureOCR() {
    const video = document.getElementById("ocrVideo");

    // T·∫°o ·∫£nh t·ª´ video
    let canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    let ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    closeOCR(); // ƒë√≥ng camera

    // OCR
    const { data: { text } } = await Tesseract.recognize(canvas, "eng", {
        logger: m => console.log(m)
    });

    processOCRResult(text);
}

function processOCRResult(text) {

    // T√¨m ng√†y d·∫°ng DD/MM/YYYY ho·∫∑c DDMMYYYY
    let pattern = /(\d{2}[\/\-\.]?\d{2}[\/\-\.]?\d{4})/g;
    let matches = text.match(pattern);

    if (!matches || matches.length === 0) {
        alert("Kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c ng√†y. H√£y ch·ª•p r√µ h∆°n!");
        return;
    }

    // Format l·∫°i
    let clean = matches.map(v => {
        v = v.replace(/\D/g, "");
        return v.slice(0,2) + "/" + v.slice(2,4) + "/" + v.slice(4);
    });

    // G√°n v√†o input MFG/EXP
    if (clean.length >= 1) document.getElementById("mfg").value = clean[0];
    if (clean.length >= 2) document.getElementById("exp").value = clean[1];

    alert("Qu√©t th√†nh c√¥ng!");
}

// =============================
// 1) Ph√°t hi·ªán mobile / PC
// =============================
const isMobile =
    /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ||
    window.innerWidth <= 768;

// =============================
// 2) H√†m auto-format dd/mm/yyyy
//    d√πng cho mobile
// =============================
function autoFormatDateInput(el) {
    if (!el) return;

    el.addEventListener("input", function () {
        // L·∫•y to√†n b·ªô s·ªë, b·ªè k√Ω t·ª± kh√°c
        let v = el.value.replace(/\D/g, "");

        // Gi·ªõi h·∫°n 8 s·ªë: ddmmyyyy
        if (v.length > 8) v = v.slice(0, 8);

        let out = "";

        if (v.length <= 2) {
            // ƒëang g√µ ng√†y
            out = v;
        } else if (v.length <= 4) {
            // ng√†y + th√°ng
            out = v.slice(0, 2) + "/" + v.slice(2);
        } else {
            // dd/mm/yyyy
            out = v.slice(0, 2) + "/" + v.slice(2, 4) + "/" + v.slice(4);
        }

        el.value = out;
    });
}

// =============================
// 3) Kh·ªüi t·∫°o input theo thi·∫øt b·ªã
// =============================
function enforcePCDateFormat(el, fp) {
    el.addEventListener("input", function () {
        let v = el.value.replace(/\D/g, "");

        if (v.length >= 8) {
            let d = v.slice(0, 2);
            let m = v.slice(2, 4);
            let y = v.slice(4, 8);

            let formatted = `${d}/${m}/${y}`;
            el.value = formatted;

            // ƒê·ªìng b·ªô v√†o flatpickr
            fp.setDate(formatted, true);
        }
    });
}

if (!isMobile) {
    // PC d√πng popup l·ªãch
    //flatpickr("#mfg", { dateFormat: "d/m/Y", allowInput: true });
    //flatpickr("#exp", { dateFormat: "d/m/Y", allowInput: true });
	const fp1 = flatpickr("#mfg", { dateFormat: "d/m/Y", allowInput: true });
    const fp2 = flatpickr("#exp", { dateFormat: "d/m/Y", allowInput: true });

    enforcePCDateFormat(document.getElementById("mfg"), fp1);
    enforcePCDateFormat(document.getElementById("exp"), fp2);
} else {
    // Mobile: ch·ªâ d√πng auto-format, kh√¥ng popup
    autoFormatDateInput(document.getElementById("mfg"));
    autoFormatDateInput(document.getElementById("exp"));
}

// =============================
// 4) Accordion
// =============================
function toggleAcc(id) {
    const body = document.getElementById(id);
    const header = body.previousElementSibling;

    if (body.style.maxHeight) {
        body.style.maxHeight = null;
        header.classList.remove("open");
    } else {
        body.style.maxHeight = body.scrollHeight + "px";
        header.classList.add("open");
    }
}

// =============================
// 5) X·ª≠ l√Ω ng√†y
// =============================
function parseDMY(str) {
    const [d, m, y] = str.split("/");
    return new Date(y, m - 1, d);
}

function formatDate(d) {
    return (
        String(d.getDate()).padStart(2, "0") +
        "/" +
        String(d.getMonth() + 1).padStart(2, "0") +
        "/" +
        d.getFullYear()
    );
}

// =============================
// 6) C·ªông / Tr·ª´ th√°ng
// =============================
function addMonths(months) {
    let mfg = document.getElementById("mfg").value;
    let exp = document.getElementById("exp").value;
    if (!mfg) return alert("Vui l√≤ng nh·∫≠p ng√†y s·∫£n xu·∫•t tr∆∞·ªõc!");

    let base = exp ? parseDMY(exp) : parseDMY(mfg);
    base.setMonth(base.getMonth() + months);

    let max = parseDMY(mfg);
    max.setFullYear(max.getFullYear() + 20);

    let min = parseDMY(mfg);

    if (base > max) base = max;
    if (base < min) base = min;

    document.getElementById("exp").value = formatDate(base);
}

// =============================
// 7) T√≠nh HSD
// =============================
function calc() {
    let mfg = document.getElementById("mfg").value;
    let exp = document.getElementById("exp").value;
    if (!mfg || !exp) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß!");

    const mfgD = parseDMY(mfg);
    const expD = parseDMY(exp);
    const now = new Date();

    if (now < mfgD)
        return (document.getElementById("result").innerHTML =
            `<div class='result-box warning'>‚ùó Ch∆∞a ƒë·∫øn ng√†y s·∫£n xu·∫•t!</div>`);

    if (now > expD)
        return (document.getElementById("result").innerHTML =
            `<div class='result-box danger'>‚ùå ƒê√É H·∫æT H·∫†N!</div>`);

    let total = expD - mfgD;
    let used = now - mfgD;

    let percentUsed = (used / total * 100).toFixed(2);
    let percentLeft = (100 - percentUsed).toFixed(2);
    let daysLeft = Math.ceil((expD - now) / 86400000);

    // Ng√†y c·∫ßn r√∫t khi c√≤n 20%
    let warnDays = Math.floor(total * 0.8);
    let warnDate = new Date(mfgD.getTime() + warnDays);
    let warnStr = formatDate(warnDate);

    let cls = "good",
        emoji = "üü¢",
        msg = "C√≤n h·∫°n s·ª≠ d·ª•ng t·ªët";
    if (percentLeft < 30) {
        cls = "danger";
        emoji = "üî¥";
        msg = "S·∫Øp h·∫øt h·∫°n!";
    } else if (percentLeft < 60) {
        cls = "warning";
        emoji = "üü°";
        msg = "H·∫°n s·ª≠ d·ª•ng trung b√¨nh";
    }

    let color =
        cls === "danger" ? "red" : cls === "warning" ? "#e67e22" : "#27ae60";

    document.getElementById("result").innerHTML = `
        <div class="result-box">
            <p><b>Ng√†y s·∫£n xu·∫•t:</b> ${mfg}</p>
            <p><b>H·∫°n s·ª≠ d·ª•ng:</b> ${exp}</p>

            <p><b>Ng√†y c·∫ßn r√∫t (c√≤n 20%):</b> 
               <span style="color:#c0392b">${warnStr}</span>
            </p>

            <p><b>C√≤n l·∫°i:</b> ${daysLeft} ng√†y</p>

            <div class="progress-bar">
                <div class="progress-fill" style="width:${percentUsed}%; background:${color}"></div>
            </div>

            <p><b>% ƒë√£ d√πng:</b> ${percentUsed}%</p>
            <p><b>% c√≤n l·∫°i:</b> ${percentLeft}%</p>

            <p class="${cls}">${emoji} <b>K·∫øt lu·∫≠n:</b> ${msg}</p>
        </div>
    `;

    saveHistory(mfg, exp, msg);
}

// =============================
// 8) L·ªãch s·ª≠ + reset
// =============================
function saveHistory(mfg, exp, msg) {
    let list = JSON.parse(localStorage.getItem("HSD_HISTORY") || "[]");

    list.unshift({
        mfg,
        exp,
        msg,
        time: new Date().toLocaleString("vi-VN")
    });

    if (list.length > 3) list.pop();

    localStorage.setItem("HSD_HISTORY", JSON.stringify(list));

    renderHistory(); // üî• Quan tr·ªçng!!!
}

function resetAll() {
    document.getElementById("mfg").value = "";
    document.getElementById("exp").value = "";
    document.getElementById("result").innerHTML = "";
}

function renderHistory() {
    let list = JSON.parse(localStorage.getItem("HSD_HISTORY") || "[]");
    let box = document.getElementById("history");

    if (!box) return;

    box.innerHTML = list
        .map(item => `
            <div style="margin-bottom:10px;">
                <b>${item.mfg}</b> ‚Üí <b>${item.exp}</b><br>
                <i>${item.msg}</i><br>
                <small>${item.time}</small>
                <hr>
            </div>
        `)
        .join("");
}
renderHistory();
</script>

<div id="ocrModal" style="
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; flex-direction:column;">
    
    <video id="ocrVideo" autoplay playsinline style="width:90%; border-radius:12px;"></video>

    <button onclick="captureOCR()" style="
        margin-top:20px; padding:12px 20px; font-size:18px; background:#27ae60; color:white; border:none; border-radius:10px;">
        üì∏ Ch·ª•p ·∫£nh
    </button>

    <button onclick="closeOCR()" style="
        margin-top:12px; padding:10px 20px; font-size:16px; background:#e74c3c; color:white; border:none; border-radius:10px;">
        ƒê√≥ng
    </button>
</div>

</body>
</html>
